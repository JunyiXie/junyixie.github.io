<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>cpython ARM64 baseline-JIT Implementation, 20% speed up | xiejunyi blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="背景 目前开源并没有可参考的，完善的，有显著性能提升的，ARM64下的cpython JIT实现。只能我们参考已由的x86架构下的实现方案，在A">
    <meta name="generator" content="Hugo 0.110.0">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="cpython ARM64 baseline-JIT Implementation, 20% speed up" />
<meta property="og:description" content="背景 目前开源并没有可参考的，完善的，有显著性能提升的，ARM64下的cpython JIT实现。只能我们参考已由的x86架构下的实现方案，在A" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/cpython-arm-jit/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-24T15:43:48+08:00" />
<meta property="article:modified_time" content="2021-11-24T15:43:48+08:00" />
<meta itemprop="name" content="cpython ARM64 baseline-JIT Implementation, 20% speed up">
<meta itemprop="description" content="背景 目前开源并没有可参考的，完善的，有显著性能提升的，ARM64下的cpython JIT实现。只能我们参考已由的x86架构下的实现方案，在A"><meta itemprop="datePublished" content="2021-11-24T15:43:48+08:00" />
<meta itemprop="dateModified" content="2021-11-24T15:43:48+08:00" />
<meta itemprop="wordCount" content="3558">
<meta itemprop="keywords" content="python,interpreter,optimization,performance,JIT," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="cpython ARM64 baseline-JIT Implementation, 20% speed up"/>
<meta name="twitter:description" content="背景 目前开源并没有可参考的，完善的，有显著性能提升的，ARM64下的cpython JIT实现。只能我们参考已由的x86架构下的实现方案，在A"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        xiejunyi blog
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/" title="This is Home page">
              This is Home
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="Archives page">
              Archives
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/tags/" title="Tags page">
              Tags
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/categories/" title="Categories page">
              Categories
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About page">
              About
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">cpython ARM64 baseline-JIT Implementation, 20% speed up</h1>
      
      <p class="tracked">
        By <strong>xiejunyi</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-11-24T15:43:48+08:00">November 24, 2021</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id="背景">背景</h2>
<p>目前开源并没有可参考的，完善的，有显著性能提升的，ARM64下的cpython JIT实现。只能我们参考已由的x86架构下的实现方案，在ARM下自研一套cpython JIT。目前 经过初步的优化，虽然人力有限（只有我半个人&hellip;），4个月的时间，我们已经成功优化了cpython3.10 <strong>20%的执行性能</strong>(pyperformance)。</p>
<blockquote>
<p>备注 pypy 复杂场景下 性能不如cpython</p>
</blockquote>
<h2 id="方案">方案</h2>
<blockquote>
<p>在<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)" title="计算 (计算机科学)">计算机技术</a>中，<strong>即时编译</strong>（英语：just-in-time compilation，缩写为<strong>JIT</strong>；又译<strong>及时编译</strong><a href="https://zh.wikipedia.org/wiki/%E5%8D%B3%E6%99%82%E7%B7%A8%E8%AD%AF#cite_note-1">[1]</a>、<strong>实时编译</strong><a href="https://zh.wikipedia.org/wiki/%E5%8D%B3%E6%99%82%E7%B7%A8%E8%AD%AF#cite_note-2">[2]</a>），也称为<strong>动态翻译</strong>或<strong>运行时编译</strong><a href="https://zh.wikipedia.org/wiki/%E5%8D%B3%E6%99%82%E7%B7%A8%E8%AD%AF#cite_note-3">[3]</a>，是一种执行<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BB%A3%E7%A0%81" title="计算机代码">计算机代码</a>的方法，这种方法涉及在程序执行过程中（在<a href="https://zh.wikipedia.org/wiki/%E5%9F%B7%E8%A1%8C%E6%9C%9F" title="执行期">执行期</a>）而不是在执行之前进行<a href="https://zh.wikipedia.org/wiki/%E7%B7%A8%E8%AD%AF%E5%99%A8" title="编译器">编译</a>。<a href="https://zh.wikipedia.org/wiki/%E5%8D%B3%E6%99%82%E7%B7%A8%E8%AD%AF#cite_note-FOOTNOTEAycock2003-4">[4]</a>通常，这包括<a href="https://zh.wikipedia.org/wiki/%E6%BA%90%E4%BB%A3%E7%A0%81" title="源代码">源代码</a>或更常见的<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E7%A0%81" title="字节码">字节码</a>到<a href="https://zh.wikipedia.org/wiki/%E6%9C%BA%E5%99%A8%E8%AF%AD%E8%A8%80" title="机器语言">机器码</a>的转换，然后直接执行。实现JIT编译器的系统通常会不断地分析正在执行的代码，并确定代码的某些部分，在这些部分中，编译或重新编译所获得的加速将超过编译该代码的开销。</p>
</blockquote>
<p>我们实现的JIT编译器主要简单的做了以下的事情：</p>
<ul>
<li>函数级别的jit编译执行</li>
<li>性能优化
<ul>
<li>get rid of bytecode dispatching</li>
<li>inline caches</li>
<li>arm level assemble optimizations</li>
<li>optimize stack use, heap operations converted to register operations</li>
</ul>
</li>
<li>兼容cpython所有的features</li>
</ul>
<h3 id="零技术选型">（零）技术选型：</h3>
<ul>
<li>Assembler: 选择了开源的VIXL，优点是支持 simulator 和 disassembler 方便调试。</li>
<li>核心的JIT编译器优化技术: 参考开源的pyston在x86_64下的方案</li>
</ul>
<h3 id="一-去除解释器字节码调度的性能损耗">（一） 去除解释器字节码调度的性能损耗</h3>
<p>对cpython解释器来说，可以简单的把它理解为一个 for 循环，每个字节码的实现在switch case 语句中。</p>
<ul>
<li>首先解释器需要获取当前的opcode</li>
<li>随后根据 opcode 跳转到switch case的具体实现。
解释器的执行，在不断的重复，解码，跳转，执行具体实现的操作。</li>
</ul>
<p>例如 LOAD_FAST 对应一个 case 语句，有它具体的一个代码的实现。
取指令和解码操作是比较耗时的，大概会占到程序总体的执行时间的7%。</p>
<p><strong>JIT如何去优化这部分的耗时呢？</strong>
说我们可以将一个函数的字节码实现直接去编译成可执行代码，然后用 CPU 去直接执行。
将字节码编译成可执行代码是一件非常复杂的事情，涉及到：</p>
<ol>
<li>原有的165个字节码的C实现，需要转换为JIT生成的汇编代码，这涉及到大量的手写汇编和优化的工作。</li>
<li>JIT编译时间要短，生成的汇编代码要高效，紧凑。</li>
<li>JIT的执行和解释器的执行要“无缝衔接”，对Runtime的运行状态要保证一致。</li>
</ol>
<p>针对165个OPCODE的实现，</p>
<ul>
<li>我们发现其中有40个是高频使用的，我们对其进行了JIT编译优化，用大量的手写生成汇编代码进行优化。大概手写了<strong>2500行</strong>ARM64的汇编代码。
参考其他在x86下python JIT方案的已有经验。</li>
</ul>
<blockquote>
<p>In pyston v1 we also had a fast JIT tier which was not using dynasm for instruction encoding (was completely written by ourselfs). That tier even though it did not use any optimizations (only got rid of bytecode dispatching + inline caches) actually turned out to give most of the speedups and the higher LLVM tier did not improve much on it but had much much higher compile time costs (as far as I remember - have been a few years).</p>
</blockquote>
<p>JIT性能主要提升来源于</p>
<ul>
<li>got rid of bytecode dispatching</li>
<li>inline caches</li>
</ul>
<p>我们就通过assembler直接生成目标代码，然后添加inline caches进行优化。</p>
<ul>
<li>剩余125个OPCODE，我们实现了一个翻译器，自动将C实现转换为JIT可用的函数调用</li>
</ul>
<h3 id="二-inline-cache优化">（二） Inline Cache优化</h3>
<blockquote>
<p><strong>内联缓存</strong>（Inline caching）是部分<a href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" title="编程语言">编程语言</a>的<a href="https://zh.wikipedia.org/wiki/%E8%BF%90%E8%A1%8C%E6%97%B6%E7%B3%BB%E7%BB%9F" title="运行时系统">运行时系统</a>采用的<a href="https://zh.wikipedia.org/w/index.php?title=%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96&amp;action=edit&amp;redlink=1">优化技术</a>，最早为<a href="https://zh.wikipedia.org/wiki/Smalltalk" title="Smalltalk">Smalltalk</a>开发<a href="https://zh.wikipedia.org/wiki/%E5%86%85%E8%81%94%E7%BC%93%E5%AD%98#cite_note-DS-1">[1]</a>。内联缓存的目标是通过记住以前直接在<a href="https://zh.wikipedia.org/w/index.php?title=Call_site&amp;action=edit&amp;redlink=1">调用点</a>上方法查询的结果来加快<a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E5%88%86%E6%B4%BE" title="动态分派">运行时方法绑定</a>的速度。内联缓存对<a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B" title="动态类型">动态类型</a>语言尤为有用，其中大多数（如非全部）方法绑定发生在运行时，因此<a href="https://zh.wikipedia.org/w/index.php?title=%E8%99%9A%E6%96%B9%E6%B3%95%E8%A1%A8&amp;action=edit&amp;redlink=1">虚方法表</a>通常无法使用。</p>
</blockquote>
<p>对cpython做inline cache优化，有以下挑战</p>
<ul>
<li>需要定位解释器主要耗时的OPCODE</li>
<li>需要根据Python语言+解释器的实现 进行特殊化</li>
<li>Python语言的特性复杂，一个OPCODE可能对应多种特殊化实现</li>
<li>大量的手写汇编工作，工作量巨大</li>
</ul>
<p>这里用简单的LOAD_GLOBAL进行举例。</p>
<p>由于Python的Global变量可以变化，因此LOAD_GLOBAL每次都需要查询内部的f_globals,f_builtins字典。如果我们预测，f_globals,f_builtins没有改变，便可以直接缓存上一次opcode的执行结果，使用。</p>
<p>下面贴一下LOAD_GLOBAL的代码，还是比较简单的，因为inline cache的case只有一种。
对于LOAD_ATTR, STORE_ATTR, LOAD_METHOD,  ..等字节码,inline cache有多种specialization情况，实现会非常复杂。这里篇幅有限，不深入介绍。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> LOAD_GLOBAL:
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                Label <span style="color:#f92672">*</span>LOAD_GLOBAL_FINISH <span style="color:#f92672">=</span> new <span style="color:#a6e22e">Label</span>();
</span></span><span style="display:flex;"><span>                Label <span style="color:#f92672">*</span>LOAD_GLOBAL_DVS <span style="color:#f92672">=</span> new <span style="color:#a6e22e">Label</span>();
</span></span><span style="display:flex;"><span>                Label <span style="color:#f92672">*</span>LOAD_GLOBAL_DROGON_CACHE_ERROR <span style="color:#f92672">=</span> new <span style="color:#a6e22e">Label</span>();
</span></span><span style="display:flex;"><span>                waiting_free_labels.<span style="color:#a6e22e">push_back</span>(LOAD_GLOBAL_FINISH);
</span></span><span style="display:flex;"><span>                waiting_free_labels.<span style="color:#a6e22e">push_back</span>(LOAD_GLOBAL_DROGON_CACHE_ERROR);
</span></span><span style="display:flex;"><span>                waiting_free_labels.<span style="color:#a6e22e">push_back</span>(LOAD_GLOBAL_DVS);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">auto</span> load_global_cold <span style="color:#f92672">=</span> [<span style="color:#f92672">=</span>, <span style="color:#f92672">&amp;</span>R_ERROR, <span style="color:#f92672">&amp;</span>masm, <span style="color:#f92672">&amp;</span>drogon_compile_state, <span style="color:#f92672">&amp;</span>offset_to_disassembler_comment] {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(cold, x16, x17);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_DISASSEMBLER_COMMENT</span>(load_global_cold);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Bind</span>(LOAD_GLOBAL_DROGON_CACHE_ERROR);
</span></span><span style="display:flex;"><span>                    DROGON_INVALID_DROGON_CACHE;
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(inline_cache_error, x16, x17)
</span></span><span style="display:flex;"><span>                    PyObject <span style="color:#f92672">*</span>name <span style="color:#f92672">=</span> <span style="color:#a6e22e">PyTuple_GET_ITEM</span>(names, oparg);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x0, (<span style="color:#66d9ef">intptr_t</span>)co_opcache);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x1, D_TSTATE);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x2, D_F);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x3, (<span style="color:#66d9ef">int64_t</span>)name);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Ldr</span>(x4, (<span style="color:#66d9ef">intptr_t</span>)co);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Ldr</span>(x5, (<span style="color:#66d9ef">intptr_t</span>)first_instr);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x6, (<span style="color:#66d9ef">intptr_t</span>)_next_instr);
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">CallRuntime</span>(DROGON_JIT_HELPER_LOAD_GLOBAL_HAND_MADE_0);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Cmp</span>(x0, R_V_goto_error);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_ERROR_HANDLER</span>(LOAD_GLOBAL, eq)
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">B</span>(LOAD_GLOBAL_DVS);
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (co_opcache <span style="color:#f92672">&amp;&amp;</span> co_opcache<span style="color:#f92672">-&gt;</span>optimized <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> co_opcache<span style="color:#f92672">-&gt;</span>num_failed <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> co_opcache<span style="color:#f92672">-&gt;</span>u.lg.globals_ver <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                    cold_code_generators.<span style="color:#a6e22e">push_back</span>(load_global_cold);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(tmp_0, x16, x17)
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    _PyOpcache_LoadGlobal <span style="color:#f92672">*</span>lg <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>co_opcache<span style="color:#f92672">-&gt;</span>u.lg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Ldr</span>(x8, <span style="color:#a6e22e">MemOperand</span>(D_F, <span style="color:#a6e22e">offsetof</span>(PyFrameObject, f_globals)));
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x9, lg<span style="color:#f92672">-&gt;</span>globals_ver);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Ldr</span>(x8, <span style="color:#a6e22e">MemOperand</span>(x8, <span style="color:#a6e22e">offsetof</span>(PyDictObject, ma_version_tag)));
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Cmp</span>(x9, x8);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">B</span>(LOAD_GLOBAL_DROGON_CACHE_ERROR, ne);
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Ldr</span>(x8, <span style="color:#a6e22e">MemOperand</span>(D_F, <span style="color:#a6e22e">offsetof</span>(PyFrameObject, f_builtins)));
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x9, lg<span style="color:#f92672">-&gt;</span>builtins_ver);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Ldr</span>(x8, <span style="color:#a6e22e">MemOperand</span>(x8, <span style="color:#a6e22e">offsetof</span>(PyDictObject, ma_version_tag)));
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Cmp</span>(x9, x8);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">B</span>(LOAD_GLOBAL_DROGON_CACHE_ERROR, ne);
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x0, (<span style="color:#66d9ef">intptr_t</span>)lg<span style="color:#f92672">-&gt;</span>ptr);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">D_PY_INCREF</span>(x0, x16);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(inline_cache_hit, x16, x17)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(hit_0, x16, x17)
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">load_global_cold</span>();                
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                __ <span style="color:#a6e22e">Bind</span>(LOAD_GLOBAL_DVS);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">convert_arg_to_stack</span>(drogon_compile_state, masm);
</span></span><span style="display:flex;"><span>                __ <span style="color:#a6e22e">Mov</span>(D_DVS_1, x0);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">deferred_vs_push</span>(drogon_compile_state, REGISTER, <span style="color:#ae81ff">26</span>, masm, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">11</span>);
</span></span><span style="display:flex;"><span>                __ <span style="color:#a6e22e">Bind</span>(LOAD_GLOBAL_FINISH);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span></code></pre></div><h3 id="三-优化cpython语言栈的使用-top-of-stack-caching">（三） 优化cpython语言栈的使用 Top-of-Stack Caching</h3>
<p>cpython是stack based vm, 很多运行时的操作数和数据存放在栈上。这里的栈可以理解为内存中的heap.频繁的存取非常耗时。</p>
<blockquote>
<p>L1 cache reference: 1 nanosecond.</p>
</blockquote>
<blockquote>
<p>L2 cache reference: 4 nanoseconds.</p>
</blockquote>
<blockquote>
<p>Mutex Lock / Unlock: 17 nanoseconds.</p>
</blockquote>
<blockquote>
<p><strong>Main memory / RAM reference: 100 nanoseconds.</strong></p>
</blockquote>
<p>我们通过在JIT编译时的一些优化，将大部分的stack操作转换为对寄存器的使用。
这里用简单的一个例子说明：</p>
<pre tabindex="0"><code>def _t_f():
        a = 1
        b = 2
        c = a + b
</code></pre><p>的字节码为</p>
<pre tabindex="0"><code>...

 83           8 LOAD_FAST                0 (a)
             10 LOAD_FAST                1 (b)
             12 BINARY_ADD
             14 STORE_FAST               2 (c)
             16 LOAD_CONST               0 (None)
             18 RETURN_VALUE
</code></pre><p>其中 LOAD_FAST, 和 BINARY_ADD 有多次对stack的使用</p>
<pre tabindex="0"><code>LOAD_FAST
    PUSH();

LOAD_FAST
    PUSH();

BINARY_ADD
    POP();
    TOP();
   ...

}
</code></pre><p>在编译时，我们可以将LOAD_FAST的PUSH记录，BINARY_ADD POP记录</p>
<p>jit deferred value stack:</p>
<pre tabindex="0"><code>push --- type: fast
push --- type: fast
</code></pre><p>在POP(),TOP()时，我们从<code>jit deferred value stack</code>依次读取记录，发现时fast变量，fast可以直接从frame的FASTLOCALS中读取。然后放到寄存器中使用。
这样就去除了大量的load_fast的数据压栈导致的性能损耗。
特殊的load_const，的const数据也是类似的原理。
具体实现如下,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>           <span style="color:#66d9ef">case</span> LOAD_FAST:
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Label <span style="color:#f92672">*</span>LOAD_FAST_VAL_NULL <span style="color:#f92672">=</span> new <span style="color:#a6e22e">Label</span>();
</span></span><span style="display:flex;"><span>                Label <span style="color:#f92672">*</span>LOAD_FAST_END <span style="color:#f92672">=</span> new <span style="color:#a6e22e">Label</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                waiting_free_labels.<span style="color:#a6e22e">push_back</span>(LOAD_FAST_VAL_NULL);
</span></span><span style="display:flex;"><span>                waiting_free_labels.<span style="color:#a6e22e">push_back</span>(LOAD_FAST_END);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>known_defined[oparg]) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">D_GETLOCAL</span>(x8, x16);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Cbz</span>(x8, LOAD_FAST_VAL_NULL);
</span></span><span style="display:flex;"><span>                    known_defined[oparg] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">deferred_vs_push</span>(drogon_compile_state, FAST, oparg, masm, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">11</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">auto</span> load_fast_cold <span style="color:#f92672">=</span> [<span style="color:#f92672">=</span>, <span style="color:#f92672">&amp;</span>R_ERROR, <span style="color:#f92672">&amp;</span>offset_to_disassembler_comment] {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(cold, x16, x17);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">DROGON_DISASSEMBLER_COMMENT</span>(load_fast_cold);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Bind</span>(LOAD_FAST_VAL_NULL);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x0, (<span style="color:#66d9ef">intptr_t</span>)co);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(w1, (<span style="color:#66d9ef">intptr_t</span>)oparg);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">Mov</span>(x2, D_TSTATE);
</span></span><span style="display:flex;"><span>                    __ <span style="color:#a6e22e">CallRuntime</span>(DROGON_JIT_HELPER_LOAD_FAST_HANDMADE_SECONDPART);
</span></span><span style="display:flex;"><span>                    DROGON_HANDLE_ERROR
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                cold_code_generators.<span style="color:#a6e22e">push_back</span>(load_fast_cold);
</span></span><span style="display:flex;"><span>                __ <span style="color:#a6e22e">Bind</span>(LOAD_FAST_END);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deferred_vs_push</span>(Drogon_Compile_State <span style="color:#f92672">*</span>drogon_compile_state, ValueStackLoc location, <span style="color:#66d9ef">int</span> value, MacroAssembler <span style="color:#f92672">*</span>masm, <span style="color:#66d9ef">int</span> helper_reg1, <span style="color:#66d9ef">int</span> helper_reg2) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">DROGON_LOG_DEBUG</span>(<span style="color:#e6db74">&#34;[CodeGen] Emit deferred_vs_push %s&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Drogon_STACK_OP_STAT_INC</span>(jit_statistics.stack_stats.total_push);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_next <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&gt;</span> DEFERRED_VS_MAX) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Drogon_STACK_OP_STAT_INC</span>(jit_statistics.stack_stats.apply_and_push);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Drogon_STACK_OP_STAT_INC</span>(jit_statistics.stack_stats.apply_stat.vs_full);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deferred_vs_apply</span>(drogon_compile_state, masm, helper_reg1, helper_reg2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    GETDEFERRED[<span style="color:#ae81ff">0</span>].loc <span style="color:#f92672">=</span> location;
</span></span><span style="display:flex;"><span>    GETDEFERRED[<span style="color:#ae81ff">0</span>].val <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>    drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_next<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (location <span style="color:#f92672">==</span> REGISTER <span style="color:#f92672">&amp;&amp;</span> value <span style="color:#f92672">==</span> <span style="color:#ae81ff">26</span>)
</span></span><span style="display:flex;"><span>        drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_register_used <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (location <span style="color:#f92672">==</span> REGISTER <span style="color:#f92672">&amp;&amp;</span> value <span style="color:#f92672">==</span> <span style="color:#ae81ff">23</span>)
</span></span><span style="display:flex;"><span>        drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_preserved_reg_used <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> RefStatus <span style="color:#a6e22e">deferred_vs_peek</span>(Drogon_Compile_State <span style="color:#f92672">*</span>drogon_compile_state, MacroAssembler <span style="color:#f92672">*</span>masm, <span style="color:#66d9ef">int</span> dst, <span style="color:#66d9ef">int</span> num, <span style="color:#66d9ef">int</span> helper_reg1, <span style="color:#66d9ef">int</span> helper_reg2) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">DROGON_LOG_DEBUG</span>(<span style="color:#e6db74">&#34;[CodeGen] Emit deferred_vs_peek %s&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Drogon_STACK_OP_STAT_INC</span>(jit_statistics.stack_stats.total_pop_and_peek);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> Register res <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">get_register_by_id</span>(dst);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> Register reg_helper1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">get_register_by_id</span>(helper_reg1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> Register reg_helper2 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">get_register_by_id</span>(helper_reg2);
</span></span><span style="display:flex;"><span>    RefStatus ref_status <span style="color:#f92672">=</span> OWNED;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_next <span style="color:#f92672">&gt;=</span> num) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> idx <span style="color:#f92672">=</span> drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_next <span style="color:#f92672">-</span> num;
</span></span><span style="display:flex;"><span>        DeferredValueStackEntry <span style="color:#f92672">*</span>entry <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs[idx];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>loc <span style="color:#f92672">==</span> CONST) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// load const, val in res
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            PyObject <span style="color:#f92672">*</span>obj <span style="color:#f92672">=</span> <span style="color:#a6e22e">PyTuple_GET_ITEM</span>(drogon_compile_state<span style="color:#f92672">-&gt;</span>consts, entry<span style="color:#f92672">-&gt;</span>val);
</span></span><span style="display:flex;"><span>            __ <span style="color:#a6e22e">Mov</span>(res, (<span style="color:#66d9ef">intptr_t</span>)obj);
</span></span><span style="display:flex;"><span>            ref_status <span style="color:#f92672">=</span> <span style="color:#a6e22e">is_immortal</span>(obj) <span style="color:#f92672">?</span> IMMORTAL : BORROWED;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (ref_status <span style="color:#f92672">==</span> IMMORTAL) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> opcode <span style="color:#f92672">=</span> drogon_compile_state<span style="color:#f92672">-&gt;</span>cur_opcode;
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">DROGON_INC_OPCODE_STATICTICS</span>(immortal_optimized, x16, x17);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>loc <span style="color:#f92672">==</span> FAST) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// load fast, val in res
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            __ <span style="color:#a6e22e">Mov</span>(reg_helper1, entry<span style="color:#f92672">-&gt;</span>val);
</span></span><span style="display:flex;"><span>            __ <span style="color:#a6e22e">Sbfiz</span>(reg_helper2, reg_helper1, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>            __ <span style="color:#a6e22e">Ldr</span>(res, <span style="color:#a6e22e">MemOperand</span>(D_FASTLOCALS, reg_helper2));
</span></span><span style="display:flex;"><span>            ref_status <span style="color:#f92672">=</span> BORROWED;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>loc <span style="color:#f92672">==</span> REGISTER) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (dst <span style="color:#f92672">!=</span> entry<span style="color:#f92672">-&gt;</span>val) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> Register <span style="color:#f92672">*</span>reg <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_register_by_id</span>(entry<span style="color:#f92672">-&gt;</span>val);
</span></span><span style="display:flex;"><span>                __ <span style="color:#a6e22e">Mov</span>(res, <span style="color:#f92672">*</span>reg);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ref_status <span style="color:#f92672">=</span> OWNED;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>loc <span style="color:#f92672">==</span> STACK) {
</span></span><span style="display:flex;"><span>            __ <span style="color:#a6e22e">Ldr</span>(res, <span style="color:#a6e22e">MemOperand</span>(sp, (entry<span style="color:#f92672">-&gt;</span>val <span style="color:#f92672">+</span> NUM_MANUAL_STACK_SLOTS) <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>            ref_status <span style="color:#f92672">=</span> OWNED;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Drogon_STACK_OP_STAT_INC</span>(jit_statistics.stack_stats.pop_from_pystack);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">D_STACK_PEEK</span>(res, num <span style="color:#f92672">-</span> drogon_compile_state<span style="color:#f92672">-&gt;</span>deferred_vs_next);
</span></span><span style="display:flex;"><span>        ref_status <span style="color:#f92672">=</span> OWNED;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ref_status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>对于其他通用的数据压栈，我们将其存放在临时事先设计好的JIT内部调用约定的专用的寄存器中，用寄存器替代heap存储数据。</p>
<h3 id="四-优化jit编译器生成的代码">（四） 优化JIT编译器生成的代码</h3>
<p>在我们的JIT编译器中，主要做了一下的生成代码优化，确保生成代码的质量高效。</p>
<ul>
<li>寄存器分配优化</li>
<li>流水线优化
<ul>
<li>指令重排</li>
<li>跳转预测</li>
</ul>
</li>
<li>局部性优化
<ul>
<li>代码冷热分区</li>
<li>代码布局优化</li>
</ul>
</li>
</ul>
<p>这里简单的介绍一个代码冷热分区的生成优化。
通常我们可以通过perf确定cpython 核心热点opcode的代码大概率的执行路径。根据这些信息，在运行时JIT编译时，可以将热代码集中生成，冷代码生成到较远的区域，提高代码的局部性。
以PY DECREF举例，通过这样的代码生成，可以优化整体1%的执行性能。</p>
<pre tabindex="0"><code>#define D_PY_XDECREF(D, T0) \
{ \
    DROGON_INC_OPCODE_STATICTICS(py_xdecref, x16, x17); \
    Label *D_PY_XDECREF_REF_ZERO = new Label(); \
    Label *D_PY_XDECREF_END = new Label(); \
    waiting_free_labels.push_back(D_PY_XDECREF_REF_ZERO); \
    waiting_free_labels.push_back(D_PY_XDECREF_END); \
    __ Cbz(D, D_PY_XDECREF_END); \
    __ Ldr(T0, MemOperand(D, 0)); \
    __ Sub(T0, T0, 1); \
    __ Str(T0, MemOperand(D, 0)); \
    __ Cmp(T0, 0); \
    __ B(D_PY_XDECREF_REF_ZERO, eq); \
    __ Bind(D_PY_XDECREF_END); \
    auto py_xdecref_cold = [=, &amp;offset_to_disassembler_comment] { \
        DROGON_INC_OPCODE_STATICTICS(cold, x16, x17);                    \
        DROGON_DISASSEMBLER_COMMENT(py_xdecref_cold); \
        __ Bind(D_PY_XDECREF_REF_ZERO); \
        __ Mov(x0, D); \
        __ CallRuntime(_Py_Dealloc); \
        __ B(D_PY_XDECREF_END); \
    }; \
    cold_code_generators.push_back(py_xdecref_cold); \
}
</code></pre><pre tabindex="0"><code>py_xdecref hot

0x00000001013f8140  b40000c9 cbz x9, #+0x18 (addr 0x1013f8158)

0x00000001013f8144  f940012a ldr x10, [x9]

0x00000001013f8148  d100054a sub x10, x10, #0x1 (1)

0x00000001013f814c  f900012a str x10, [x9]

0x00000001013f8150  f100015f cmp x10, #0x0 (0)

0x00000001013f8154  54000600 b.eq #+0xc0 (addr 0x1013f8214)




py_xdecref_cold

0x00000001013f8214  aa0903e0 mov x0, x9

0x00000001013f8218  d287ca90 mov x16, #0x3e54

0x00000001013f821c  f2a01830 movk x16, #0xc1, lsl #16

0x00000001013f8220  f2c00030 movk x16, #0x1, lsl #32

0x00000001013f8224  d63f0200 blr x16

0x00000001013f8228  17ffffcc b #-0xd0 (addr 0x1013f8158)
</code></pre><p><strong>代码布局优化</strong>
JIT 通过VIXL生成可执行代码。如果生成的可执行代码块的内存位置是随机内存分配的。从整个虚拟机执行的角度来看，局部性会变差。</p>
<p>这里我们通过mmap的MAP_FIXED_NOREPLACE功能去改进代码的局部性。原理是将jit生成的代码内存排部在虚拟机so的内存之后。这个优化可以提供2%的性能加速。
MAP_FIXED_NOREPLACE会尝试将mmap分配的内存分配在指定的addr处。</p>
<pre tabindex="0"><code>mmap(start_addr, CODE_BUFFER_SIZE, MAP_FIXED_NOREPLACE | PROT_READ | PROT_WRITE,
                                     MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</code></pre><h2 id="后续">后续</h2>
<p>我们目前只完成了初步的JIT优化，
后续会</p>
<ol>
<li>增加inline caches</li>
<li>融合pyston 后续开发的 ARM JIT 的优化</li>
<li>开发Tracebased-JIT</li>
</ol>
<h2 id="招聘">招聘</h2>
<blockquote>
<p>字节跳动 招聘 Python虚拟机优化方向，工作内容主要为优化cpython解释器，优化cpythonJIT（自研），优化cpython常用三方库。欢迎联系 微信: <strong>xiejunyiiii</strong>。邮箱: <strong><a href="mailto:xiejunyi.arch@bytedance.com">xiejunyi.arch@bytedance.com</a></strong></p>
</blockquote>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/python/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">python</a>
   </li>
  
   <li class="list di">
     <a href="/tags/interpreter/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">interpreter</a>
   </li>
  
   <li class="list di">
     <a href="/tags/optimization/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">optimization</a>
   </li>
  
   <li class="list di">
     <a href="/tags/performance/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">performance</a>
   </li>
  
   <li class="list di">
     <a href="/tags/jit/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">JIT</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/post/python-interpreter-parallell/">Implementation Python Interpreter Parallel in Python 3.10</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/about/">About</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  xiejunyi blog 2023 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
